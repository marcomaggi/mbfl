# program.test --
#
# Part of: Marco's BASH Functions Library
# Contents: tests for the program.sh functions
# Date: Wed Feb  4, 2004
#
# Abstract
#
#
# Copyright (c) 2004, 2005, 2012, 2013, 2014, 2018, 2020 Marco Maggi
# <mrc.mgg@gmail.com>
#
# This is free  software you can redistribute it  and/or modify it under
# the terms of  the GNU General Public License as  published by the Free
# Software Foundation; either  version 3, or (at your  option) any later
# version.
#
# This  file is  distributed in  the hope  that it  will be  useful, but
# WITHOUT   ANY  WARRANTY;  without   even  the   implied  warranty   of
# MERCHANTABILITY  or FITNESS  FOR A  PARTICULAR PURPOSE.   See  the GNU
# General Public License for more details.
#
# You  should have received  a copy  of the  GNU General  Public License
# along with this file; see the file COPYING.  If not, write to the Free
# Software Foundation,  Inc., 59  Temple Place -  Suite 330,  Boston, MA
# 02111-1307, USA.
#

#PAGE
#### setup

source setup.sh

#page
#### splitting path

function program-split-path-1.1 () {
    if mbfl_program_split_path
    then
	for ((i=0; i < ${#mbfl_split_PATH[@]}; ++i))
	do echo "${mbfl_split_PATH[$i]}"
	done
    fi
}

#PAGE
#### run simple programs

function program-1.1 () {
    mbfl_program_exec echo 123 | dotest-output 123
}
function program-1.2 () {
    mbfl_set_option_test
    mbfl_program_exec echo 123 2>&1 | dotest-output "command echo 123 <&0 >&1"
}
function program-1.3 () {
    mbfl_program_exec true
}
function program-1.4 () {
    ! mbfl_program_exec false
}

#page
#### tests for mbfl_declare_program and related stuff

function program-3.1 () {
    {
	mbfl_set_option_verbose
	mbfl_message_set_channel 1
	mbfl_message_set_progname "test"
	mbfl_declare_program /bin/ls
	mbfl_program_validate_declared
	mbfl_unset_option_verbose
    } | dotest-output 'test: found "/bin/ls": "/bin/ls"'
}
function program-3.2 () {
    mbfl_declare_program unexistent
    ! mbfl_program_validate_declared &>/dev/null
}
function program-3.3 () {
    mbfl_declare_program /bin/ls
    mbfl_program_found /bin/ls | dotest-output /bin/ls
}
function program-3.4 () {
    mbfl_declare_program unexistent
    mbfl_program_found unexistent | dotest-output
}
function program-3.5 () {
    local ret=0

    mbfl_set_option_verbose
    mbfl_message_set_channel 1
    mbfl_message_set_progname "test"
    mbfl_declare_program unexistent
    mbfl_program_validate_declared | dotest-output 'test: *** not found "unexistent", path: ""'
}

#page
#### tests for sudo invocation

function program-4.1 () {
    local CODE
    mbfl_program_enable_sudo
    mbfl_set_option_test
    {
	mbfl_program_declare_sudo_user root
	echo 123 | mbfl_program_exec cat 2>&1 | \
            dotest-output "command $mbfl_program_SUDO -u root cat <&0 >&1"
	CODE=$?
    }
    mbfl_unset_option_test
    return $CODE
}
function program-4.2 () {
    local CODE
    mbfl_program_enable_sudo
    mbfl_set_option_test
    {
	mbfl_program_declare_sudo_user root
	mbfl_program_declare_sudo_options -H VAL=val
	echo 123 | mbfl_program_exec cat 2>&1 | \
            dotest-output "command $mbfl_program_SUDO -H VAL=val -u root cat <&0 >&1"
	CODE=$?
    }
    mbfl_unset_option_test
    return $CODE
}

#page
#### tests for background execution

# Background execution with "mbfl_program_execbg2()".
#
function program-5.1 () {
    local -r DIR=$(dotest-echo-tmpdir)

    dotest-mkfile test-input.txt
    dotest-mkfile test-output.txt
    dotest-mkfile test-error.txt
    {
	echo inp >"$DIR"/test-input.txt

	if mbfl_fd_open_input 10 "$DIR"/test-input.txt
	then
	    if mbfl_fd_open_output 11 "$DIR"/test-output.txt
	    then
		if mbfl_fd_open_output 12 "$DIR"/test-error.txt
		then
		    mbfl_set_option_show_program
		    mbfl_program_execbg2 10 11 12 "$BASH" -c 'echo -n out >&1; echo -n err >&2; read -n 0 ; echo -n "$REPLY" >&1'
		    if wait $mbfl_program_BGPID
		    then
			if false
			then
			    echo  input="$(<"$DIR"/test-input.txt)"  >&2
			    echo output="$(<"$DIR"/test-output.txt)" >&2
			    echo  error="$(<"$DIR"/test-error.txt)"  >&2
			fi
			dotest-equal     'inp'    "$(<"$DIR"/test-input.txt)"  && \
			    dotest-equal 'outinp' "$(<"$DIR"/test-output.txt)" && \
			    dotest-equal 'err'    "$(<"$DIR"/test-error.txt)"
		    else dotest-printf 'error in the background process'
		    fi
		else dotest-printf 'error opening error file'
		fi
	    else dotest-printf 'error opening output file'
	    fi
	else dotest-printf 'error opening input file'
	fi

	mbfl_fd_close 10
	mbfl_fd_close 11
	mbfl_fd_close 12
    }
    dotest-clean-files
}

#page
#### tests for background execution

# Background execution with "mbfl_program_execbg()".
#
function program-5.2.1 () {
    local -r DIR=$(dotest-echo-tmpdir)

    dotest-mkfile test-input.txt
    dotest-mkfile test-output.txt
    {
	echo inp >"$DIR"/test-input.txt

	if mbfl_fd_open_input 10 "$DIR"/test-input.txt
	then
	    if mbfl_fd_open_output 11 "$DIR"/test-output.txt
	    then
		mbfl_set_option_show_program
		mbfl_program_execbg 10 11 "$BASH" -c 'echo -n out >&1; read -n 0 ; echo -n "$REPLY" >&1'
		if wait $mbfl_program_BGPID
		then
		    if false
		    then
			echo  input="$(<"$DIR"/test-input.txt)"  >&2
			echo output="$(<"$DIR"/test-output.txt)" >&2
		    fi
		    dotest-equal     'inp'    "$(<"$DIR"/test-input.txt)"  && \
			dotest-equal 'outinp' "$(<"$DIR"/test-output.txt)"
		else dotest-printf 'error in the background process'
		fi
	    else dotest-printf 'error opening output file'
	    fi
	else dotest-printf 'error opening input file'
	fi

	mbfl_fd_close 10
	mbfl_fd_close 11
    }
    dotest-clean-files
}

# Background execution with "mbfl_program_execbg()" with stderr-to-stdout redirection.
#
function program-5.2.2 () {
    local -r DIR=$(dotest-echo-tmpdir)

    dotest-mkfile test-input.txt
    dotest-mkfile test-output.txt
    {
	echo inp >"$DIR"/test-input.txt

	if mbfl_fd_open_input 10 "$DIR"/test-input.txt
	then
	    if mbfl_fd_open_output 11 "$DIR"/test-output.txt
	    then
		mbfl_program_redirect_stderr_to_stdout
		mbfl_set_option_show_program
		mbfl_program_execbg 10 11 "$BASH" -c 'echo -n out >&1; echo -n err >&2 ; read -n 0 ; echo -n "$REPLY" >&1'
		if wait $mbfl_program_BGPID
		then
		    if false
		    then
			echo  input="$(<"$DIR"/test-input.txt)"  >&2
			echo output="$(<"$DIR"/test-output.txt)" >&2
		    fi
		    dotest-equal     'inp'       "$(<"$DIR"/test-input.txt)"  && \
			dotest-equal 'outerrinp' "$(<"$DIR"/test-output.txt)"
		else dotest-printf 'error in the background process'
		fi
	    else dotest-printf 'error opening output file'
	    fi
	else dotest-printf 'error opening input file'
	fi

	mbfl_fd_close 10
	mbfl_fd_close 11
    }
    dotest-clean-files
}

#PAGE
#### let's go

dotest program-
dotest-final-report

### end of file
# Local Variables:
# mode: sh
# End:
